% Auto-generated by cameraCalibrator app on 25-Nov-2024
%-------------------------------------------------------


% Define images to process
imageFileNames = {'C:\Users\usuario\Documents\CiDIS\Stereo_Thermal\Code\CalibrationData\Steven\thermal_invert\thermal_20241113_141715.png',...
    'C:\Users\usuario\Documents\CiDIS\Stereo_Thermal\Code\CalibrationData\Steven\thermal_invert\thermal_20241113_141719.png',...
    'C:\Users\usuario\Documents\CiDIS\Stereo_Thermal\Code\CalibrationData\Steven\thermal_invert\thermal_20241113_141722.png',...
    'C:\Users\usuario\Documents\CiDIS\Stereo_Thermal\Code\CalibrationData\Steven\thermal_invert\thermal_20241113_141727.png',...
    'C:\Users\usuario\Documents\CiDIS\Stereo_Thermal\Code\CalibrationData\Steven\thermal_invert\thermal_20241113_141728.png',...
    'C:\Users\usuario\Documents\CiDIS\Stereo_Thermal\Code\CalibrationData\Steven\thermal_invert\thermal_20241113_141732.png',...
    'C:\Users\usuario\Documents\CiDIS\Stereo_Thermal\Code\CalibrationData\Steven\thermal_invert\thermal_20241113_141738.png',...
    'C:\Users\usuario\Documents\CiDIS\Stereo_Thermal\Code\CalibrationData\Steven\thermal_invert\thermal_20241113_141741.png',...
    'C:\Users\usuario\Documents\CiDIS\Stereo_Thermal\Code\CalibrationData\Steven\thermal_invert\thermal_20241113_141744.png',...
    'C:\Users\usuario\Documents\CiDIS\Stereo_Thermal\Code\CalibrationData\Steven\thermal_invert\thermal_20241113_141746.png',...
    'C:\Users\usuario\Documents\CiDIS\Stereo_Thermal\Code\CalibrationData\Steven\thermal_invert\thermal_20241113_141749.png',...
    'C:\Users\usuario\Documents\CiDIS\Stereo_Thermal\Code\CalibrationData\Steven\thermal_invert\thermal_20241113_141752.png',...
    'C:\Users\usuario\Documents\CiDIS\Stereo_Thermal\Code\CalibrationData\Steven\thermal_invert\thermal_20241113_141756.png',...
    'C:\Users\usuario\Documents\CiDIS\Stereo_Thermal\Code\CalibrationData\Steven\thermal_invert\thermal_20241113_141759.png',...
    'C:\Users\usuario\Documents\CiDIS\Stereo_Thermal\Code\CalibrationData\Steven\thermal_invert\thermal_20241113_141802.png',...
    'C:\Users\usuario\Documents\CiDIS\Stereo_Thermal\Code\CalibrationData\Steven\thermal_invert\thermal_20241113_141804.png',...
    'C:\Users\usuario\Documents\CiDIS\Stereo_Thermal\Code\CalibrationData\Steven\thermal_invert\thermal_20241113_141806.png',...
    'C:\Users\usuario\Documents\CiDIS\Stereo_Thermal\Code\CalibrationData\Steven\thermal_invert\thermal_20241113_141809.png',...
    'C:\Users\usuario\Documents\CiDIS\Stereo_Thermal\Code\CalibrationData\Steven\thermal_invert\thermal_20241113_141812.png',...
    'C:\Users\usuario\Documents\CiDIS\Stereo_Thermal\Code\CalibrationData\Steven\thermal_invert\thermal_20241113_141814.png',...
    'C:\Users\usuario\Documents\CiDIS\Stereo_Thermal\Code\CalibrationData\Steven\thermal_invert\thermal_20241113_141817.png',...
    'C:\Users\usuario\Documents\CiDIS\Stereo_Thermal\Code\CalibrationData\Steven\thermal_invert\thermal_20241113_141820.png',...
    'C:\Users\usuario\Documents\CiDIS\Stereo_Thermal\Code\CalibrationData\Steven\thermal_invert\thermal_20241113_141823.png',...
    'C:\Users\usuario\Documents\CiDIS\Stereo_Thermal\Code\CalibrationData\Steven\thermal_invert\thermal_20241113_141828.png',...
    'C:\Users\usuario\Documents\CiDIS\Stereo_Thermal\Code\CalibrationData\Steven\thermal_invert\thermal_20241113_141832.png',...
    'C:\Users\usuario\Documents\CiDIS\Stereo_Thermal\Code\CalibrationData\Steven\thermal_invert\thermal_20241113_141835.png',...
    'C:\Users\usuario\Documents\CiDIS\Stereo_Thermal\Code\CalibrationData\Steven\thermal_invert\thermal_20241113_141840.png',...
    'C:\Users\usuario\Documents\CiDIS\Stereo_Thermal\Code\CalibrationData\Steven\thermal_invert\thermal_20241113_141843.png',...
    'C:\Users\usuario\Documents\CiDIS\Stereo_Thermal\Code\CalibrationData\Steven\thermal_invert\thermal_20241113_141846.png',...
    'C:\Users\usuario\Documents\CiDIS\Stereo_Thermal\Code\CalibrationData\Steven\thermal_invert\thermal_20241113_141849.png',...
    'C:\Users\usuario\Documents\CiDIS\Stereo_Thermal\Code\CalibrationData\Steven\thermal_invert\thermal_20241113_141852.png',...
    'C:\Users\usuario\Documents\CiDIS\Stereo_Thermal\Code\CalibrationData\Steven\thermal_invert\thermal_20241113_141855.png',...
    'C:\Users\usuario\Documents\CiDIS\Stereo_Thermal\Code\CalibrationData\Steven\thermal_invert\thermal_20241113_141858.png',...
    'C:\Users\usuario\Documents\CiDIS\Stereo_Thermal\Code\CalibrationData\Steven\thermal_invert\thermal_20241113_141901.png',...
    'C:\Users\usuario\Documents\CiDIS\Stereo_Thermal\Code\CalibrationData\Steven\thermal_invert\thermal_20241113_141905.png',...
    'C:\Users\usuario\Documents\CiDIS\Stereo_Thermal\Code\CalibrationData\Steven\thermal_invert\thermal_20241113_141909.png',...
    'C:\Users\usuario\Documents\CiDIS\Stereo_Thermal\Code\CalibrationData\Steven\thermal_invert\thermal_20241113_141912.png',...
    'C:\Users\usuario\Documents\CiDIS\Stereo_Thermal\Code\CalibrationData\Steven\thermal_invert\thermal_20241113_141915.png',...
    'C:\Users\usuario\Documents\CiDIS\Stereo_Thermal\Code\CalibrationData\Steven\thermal_invert\thermal_20241113_141918.png',...
    'C:\Users\usuario\Documents\CiDIS\Stereo_Thermal\Code\CalibrationData\Steven\thermal_invert\thermal_20241113_141924.png',...
    'C:\Users\usuario\Documents\CiDIS\Stereo_Thermal\Code\CalibrationData\Steven\thermal_invert\thermal_20241113_141929.png',...
    'C:\Users\usuario\Documents\CiDIS\Stereo_Thermal\Code\CalibrationData\Steven\thermal_invert\thermal_20241113_141931.png',...
    'C:\Users\usuario\Documents\CiDIS\Stereo_Thermal\Code\CalibrationData\Steven\thermal_invert\thermal_20241113_141934.png',...
    'C:\Users\usuario\Documents\CiDIS\Stereo_Thermal\Code\CalibrationData\Steven\thermal_invert\thermal_20241113_141937.png',...
    'C:\Users\usuario\Documents\CiDIS\Stereo_Thermal\Code\CalibrationData\Steven\thermal_invert\thermal_20241113_141940.png',...
    'C:\Users\usuario\Documents\CiDIS\Stereo_Thermal\Code\CalibrationData\Steven\thermal_invert\thermal_20241113_141944.png',...
    'C:\Users\usuario\Documents\CiDIS\Stereo_Thermal\Code\CalibrationData\Steven\thermal_invert\thermal_20241113_141950.png',...
    'C:\Users\usuario\Documents\CiDIS\Stereo_Thermal\Code\CalibrationData\Steven\thermal_invert\thermal_20241113_141953.png',...
    'C:\Users\usuario\Documents\CiDIS\Stereo_Thermal\Code\CalibrationData\Steven\thermal_invert\thermal_20241113_141957.png',...
    'C:\Users\usuario\Documents\CiDIS\Stereo_Thermal\Code\CalibrationData\Steven\thermal_invert\thermal_20241113_142000.png',...
    'C:\Users\usuario\Documents\CiDIS\Stereo_Thermal\Code\CalibrationData\Steven\thermal_invert\thermal_20241113_142007.png',...
    'C:\Users\usuario\Documents\CiDIS\Stereo_Thermal\Code\CalibrationData\Steven\thermal_invert\thermal_20241113_142010.png',...
    'C:\Users\usuario\Documents\CiDIS\Stereo_Thermal\Code\CalibrationData\Steven\thermal_invert\thermal_20241113_142014.png',...
    'C:\Users\usuario\Documents\CiDIS\Stereo_Thermal\Code\CalibrationData\Steven\thermal_invert\thermal_20241113_142019.png',...
    'C:\Users\usuario\Documents\CiDIS\Stereo_Thermal\Code\CalibrationData\Steven\thermal_invert\thermal_20241113_142022.png',...
    'C:\Users\usuario\Documents\CiDIS\Stereo_Thermal\Code\CalibrationData\Steven\thermal_invert\thermal_20241113_142028.png',...
    'C:\Users\usuario\Documents\CiDIS\Stereo_Thermal\Code\CalibrationData\Steven\thermal_invert\thermal_20241113_142031.png',...
    'C:\Users\usuario\Documents\CiDIS\Stereo_Thermal\Code\CalibrationData\Steven\thermal_invert\thermal_20241113_142035.png',...
    'C:\Users\usuario\Documents\CiDIS\Stereo_Thermal\Code\CalibrationData\Steven\thermal_invert\thermal_20241113_142038.png',...
    'C:\Users\usuario\Documents\CiDIS\Stereo_Thermal\Code\CalibrationData\Steven\thermal_invert\thermal_20241113_142040.png',...
    'C:\Users\usuario\Documents\CiDIS\Stereo_Thermal\Code\CalibrationData\Steven\thermal_invert\thermal_20241113_142042.png',...
    'C:\Users\usuario\Documents\CiDIS\Stereo_Thermal\Code\CalibrationData\Steven\thermal_invert\thermal_20241113_142044.png',...
    'C:\Users\usuario\Documents\CiDIS\Stereo_Thermal\Code\CalibrationData\Steven\thermal_invert\thermal_20241113_142046.png',...
    'C:\Users\usuario\Documents\CiDIS\Stereo_Thermal\Code\CalibrationData\Steven\thermal_invert\thermal_20241113_142049.png',...
    'C:\Users\usuario\Documents\CiDIS\Stereo_Thermal\Code\CalibrationData\Steven\thermal_invert\thermal_20241113_142052.png',...
    'C:\Users\usuario\Documents\CiDIS\Stereo_Thermal\Code\CalibrationData\Steven\thermal_invert\thermal_20241113_142055.png',...
    };
% Detect calibration pattern in images
detector = vision.calibration.monocular.CheckerboardDetector();
minCornerMetric = 0.150000;
[imagePoints, imagesUsed] = detectPatternPoints(detector, imageFileNames, 'MinCornerMetric', minCornerMetric);
imageFileNames = imageFileNames(imagesUsed);

% Read the first image to obtain image size
originalImage = imread(imageFileNames{1});
[mrows, ncols, ~] = size(originalImage);

% Generate world coordinates for the planar pattern keypoints
squareSize = 20.000000;  % in millimeters
worldPoints = generateWorldPoints(detector, 'SquareSize', squareSize);

% Calibrate the camera
[cameraParams, imagesUsed, estimationErrors] = estimateCameraParameters(imagePoints, worldPoints, ...
    'EstimateSkew', false, 'EstimateTangentialDistortion', false, ...
    'NumRadialDistortionCoefficients', 2, 'WorldUnits', 'millimeters', ...
    'InitialIntrinsicMatrix', [], 'InitialRadialDistortion', [], ...
    'ImageSize', [mrows, ncols]);

% View reprojection errors
h1=figure; showReprojectionErrors(cameraParams);

% Visualize pattern locations
h2=figure; showExtrinsics(cameraParams, 'CameraCentric');

% Display parameter estimation errors
displayErrors(estimationErrors, cameraParams);

% For example, you can use the calibration data to remove effects of lens distortion.
undistortedImage = undistortImage(originalImage, cameraParams);

% See additional examples of how to use the calibration data.  At the prompt type:
% showdemo('MeasuringPlanarObjectsExample')
% showdemo('StructureFromMotionExample')
%% 
% Directorios de entrada y salida
inputDir = 'C:\Users\usuario\Documents\MATLAB\thermal';  % Carpeta de imágenes originales
outputDir = 'C:\Users\usuario\Documents\MATLAB\rectified_thermal'; % Carpeta de imágenes sin distorsión

% Crear carpeta de salida si no existe
if ~exist(outputDir, 'dir')
    mkdir(outputDir);
end

% Obtener lista de imágenes en la carpeta de entrada
imageFiles = dir(fullfile(inputDir, '*.*')); % Todos los archivos
imageFiles = imageFiles(~[imageFiles.isdir]); % Filtrar directorios

% Detectar patrón de calibración en imágenes
detector = vision.calibration.monocular.CheckerboardDetector();
minCornerMetric = 0.150000;
imageFileNames = fullfile(inputDir, {imageFiles.name});
[imagePoints, imagesUsed] = detectPatternPoints(detector, imageFileNames, 'MinCornerMetric', minCornerMetric);
imageFileNames = imageFileNames(imagesUsed);

% Leer la primera imagen para obtener el tamaño
originalImage = imread(imageFileNames{1});
[mrows, ncols, ~] = size(originalImage);

% Generar coordenadas del patrón de calibración
squareSize = 20.000000;  % en milímetros
worldPoints = generateWorldPoints(detector, 'SquareSize', squareSize);

% Calibrar la cámara
[cameraParams, imagesUsed, estimationErrors] = estimateCameraParameters(imagePoints, worldPoints, ...
    'EstimateSkew', false, 'EstimateTangentialDistortion', false, ...
    'NumRadialDistortionCoefficients', 2, 'WorldUnits', 'millimeters', ...
    'InitialIntrinsicMatrix', [], 'InitialRadialDistortion', [], ...
    'ImageSize', [mrows, ncols]);

% Mostrar errores de reproyección
h1 = figure; showReprojectionErrors(cameraParams);

% Visualizar ubicaciones del patrón
h2 = figure; showExtrinsics(cameraParams, 'CameraCentric');

% Mostrar errores de estimación
displayErrors(estimationErrors, cameraParams);

% Procesar todas las imágenes para eliminar la distorsión
for i = 1:numel(imageFiles)
    try
        % Leer imagen original
        inputFile = fullfile(inputDir, imageFiles(i).name);
        if ~exist(inputFile, 'file')
            fprintf('Archivo no encontrado: %s\n', inputFile);
            continue;
        end
        
        I = imread(inputFile);

        % Verificar tamaño de la imagen
        if size(I, 1) ~= mrows || size(I, 2) ~= ncols
            fprintf('Ajustando tamaño de la imagen %s para que coincida con la calibración.\n', imageFiles(i).name);
            I = imresize(I, [mrows, ncols]);
        end

        % Eliminar distorsión de la imagen
        undistortedImage = undistortImage(I, cameraParams);

        % Construir ruta de salida
        outputFile = fullfile(outputDir, imageFiles(i).name);

        % Guardar imagen sin distorsión
        imwrite(undistortedImage, outputFile);

        % Mensaje de progreso
        fprintf('Imagen %d/%d procesada: %s\n', i, numel(imageFiles), imageFiles(i).name);
    catch ME
        fprintf('Error procesando la imagen %s: %s\n', imageFiles(i).name, ME.message);
        continue;
    end
end

% Mensaje final
disp('Todas las imágenes han sido procesadas.');
